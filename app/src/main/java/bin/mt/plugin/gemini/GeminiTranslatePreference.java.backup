package bin.mt.plugin.gemini;

import android.content.SharedPreferences;
import android.text.InputType;

import java.util.regex.Pattern;

import bin.mt.plugin.api.LocalString;
import bin.mt.plugin.api.PluginContext;
import bin.mt.plugin.api.preference.PluginPreference;

/**
 * Preference screen for Gemini AI Translation plugin
 *
 * @author MT Manager Plugin Developer
 * @version 1.0.0
 */
public class GeminiTranslatePreference implements PluginPreference {

    private LocalString localString;
    private PluginContext context;
    private SharedPreferences preferences;

    @Override
    public void onBuild(PluginContext context, Builder builder) {
        this.context = context;
        this.localString = context.getAssetLocalString("GeminiTranslate");
        if (this.localString == null) {
            this.localString = context.getLocalString();
        }
        this.preferences = context.getPreferences();

        builder.setLocalString(localString);

        // ==================== Quick Actions ====================
        boolean quickActionsExpanded = preferences.getBoolean("section_quick_actions_expanded", true);
        builder.addText("{pref_header_quick_actions}")
                .summary(quickActionsExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_quick_actions_expanded", true);
                    preferences.edit().putBoolean("section_quick_actions_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (quickActionsExpanded) {
            builder.addText("{pref_action_test_provider}")
                    .summary("{pref_action_test_provider_summary}")
                    .onClick((pluginUI, item) -> showInteractiveProviderTest(pluginUI));

            builder.addText("{pref_action_view_logs}")
                    .summary("{pref_action_view_logs_summary}")
                    .onClick((pluginUI, item) -> context.openLogViewer());

            // Smart Quick Settings
            builder.addList("{pref_quick_switch_engine}", GeminiConstants.PREF_DEFAULT_ENGINE)
                    .defaultValue(GeminiConstants.DEFAULT_ENGINE)
                    .summary("{pref_quick_switch_engine_summary}")
                    .addItem("{pref_ai_engine_gemini}", GeminiConstants.ENGINE_GEMINI)
                    .addItem("{pref_ai_engine_openai}", GeminiConstants.ENGINE_OPENAI)
                    .addItem("{pref_ai_engine_claude}", GeminiConstants.ENGINE_CLAUDE);

            builder.addList("{pref_quick_select_model}", GeminiConstants.PREF_MODEL_NAME)
                    .defaultValue(GeminiConstants.DEFAULT_MODEL)
                    .summary("{pref_quick_select_model_summary}")
                    .addItem("{model_flash}", GeminiConstants.MODEL_GEMINI_25_FLASH)
                    .addItem("{model_flash_lite}", GeminiConstants.MODEL_GEMINI_25_FLASH_LITE)
                    .addItem("{model_pro}", GeminiConstants.MODEL_GEMINI_25_PRO)
                    .addItem("{model_legacy}", GeminiConstants.MODEL_GEMINI_20_FLASH);

            builder.addSwitch("{pref_quick_toggle_debug}", GeminiConstants.PREF_ENABLE_DEBUG)
                    .defaultValue(GeminiConstants.DEFAULT_ENABLE_DEBUG)
                    .summary("{pref_quick_toggle_debug_summary}");
        }

        // ==================== Header ====================
        builder.addHeader("{pref_header_main}");

        builder.addText("{pref_plugin_name}")
                .summary("{pref_plugin_description}");

        // ==================== Dashboard Card ====================
        builder.addText("{pref_dashboard_card_title}")
                .summary("{pref_dashboard_card_summary}")
                .onClick((pluginUI, item) -> showDashboardCard(pluginUI));

        builder.addText("{pref_active_provider_title}")
                .summary(getActiveProviderSummary());

        // ==================== API Configuration ====================
        boolean apiConfigExpanded = preferences.getBoolean("section_api_config_expanded", true);
        builder.addText("{pref_header_api_config}")
                .summary(apiConfigExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_api_config_expanded", true);
                    preferences.edit().putBoolean("section_api_config_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (apiConfigExpanded) {
            // API Key input
            builder.addInput("{pref_api_key_title}", GeminiConstants.PREF_API_KEY)
                    .defaultValue(GeminiConstants.DEFAULT_API_KEY)
                    .summary("{pref_api_key_summary}")
                    .valueAsSummary()
                    .inputType(InputType.TYPE_CLASS_TEXT | InputType.TYPE_TEXT_VARIATION_PASSWORD);

            // Visual divider - subtle separator
            builder.addText("")
                    .summary("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€");

            builder.addText("{pref_gemini_key_status_title}")
                    .summary(getKeyStatusDescription(
                            preferences.getString(GeminiConstants.PREF_API_KEY, ""),
                            GeminiConstants.API_KEY_PATTERN,
                            localString.get("pref_status_provider_gemini")));

            // Test API key button with visual feedback
            builder.addText("{pref_test_api_key}")
                .summary("{pref_test_api_key_summary}")
                .onClick((pluginUI, item) -> {
                    item.setSummary("â³ Testing API key...");
                    
                    SharedPreferences prefs = context.getPreferences();
                    String apiKey = prefs.getString(GeminiConstants.PREF_API_KEY, "");
                    String model = prefs.getString(GeminiConstants.PREF_MODEL_NAME, GeminiConstants.DEFAULT_MODEL);

                    if (apiKey.isEmpty()) {
                        item.setSummary("âŒ " + localString.get("error_no_api_key"));
                        context.showToast(localString.get("error_no_api_key"));
                        return;
                    }

                    new Thread(() -> {
                        try {
                            // Build test request
                            org.json.JSONObject request = new org.json.JSONObject();
                            org.json.JSONArray contents = new org.json.JSONArray();
                            org.json.JSONObject content = new org.json.JSONObject();
                            org.json.JSONArray parts = new org.json.JSONArray();
                            org.json.JSONObject part = new org.json.JSONObject();
                            part.put("text", "Translate to Turkish: Hello");
                            parts.put(part);
                            content.put("parts", parts);
                            contents.put(content);
                            request.put("contents", contents);

                            // Test API
                            String apiUrl = String.format("%s/%s:generateContent?key=%s",
                                GeminiConstants.API_BASE_URL, model, apiKey);

                            GeminiHttpUtils.Request httpRequest = GeminiHttpUtils.post(apiUrl);
                            httpRequest.setTimeout(10000);
                            httpRequest.jsonBody(request);

                            org.json.JSONObject response = httpRequest.executeToJson();

                            if (response.has("candidates")) {
                                item.setSummary("âœ… " + localString.get("msg_api_key_valid"));
                                context.showToast(localString.get("msg_api_key_valid"));
                            } else {
                                item.setSummary("âŒ " + localString.get("error_api_key_invalid"));
                                context.showToast(localString.get("error_api_key_invalid"));
                            }

                        } catch (Exception e) {
                            String errorMsg = localString.get("error_api_test_failed") + ": " + e.getMessage();
                            item.setSummary("âŒ " + errorMsg);
                            context.showToast(errorMsg);
                        }
                    }).start();
                });

            // Link to get API key
            builder.addText("{pref_get_api_key}")
                    .summary("{pref_get_api_key_summary}")
                    .url(GeminiConstants.URL_GET_API_KEY);
        }

        // ==================== AI Engine Selection ====================
        boolean aiEngineExpanded = preferences.getBoolean("section_ai_engine_expanded", true);
        builder.addText("{pref_header_ai_engine}")
                .summary(aiEngineExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_ai_engine_expanded", true);
                    preferences.edit().putBoolean("section_ai_engine_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (aiEngineExpanded) {
            builder.addList("{pref_default_ai_engine}", GeminiConstants.PREF_DEFAULT_ENGINE)
                    .defaultValue(GeminiConstants.DEFAULT_ENGINE)
                    .summary("{pref_default_ai_engine_summary}")
                    .addItem("{pref_ai_engine_gemini}", GeminiConstants.ENGINE_GEMINI)
                    .addItem("{pref_ai_engine_openai}", GeminiConstants.ENGINE_OPENAI)
                    .addItem("{pref_ai_engine_claude}", GeminiConstants.ENGINE_CLAUDE);

            builder.addText("{pref_ai_engine_tip}")
                    .summary("{pref_ai_engine_tip_summary}");
        }

        // ==================== Context ====================
        boolean contextExpanded = preferences.getBoolean("section_context_expanded", false);
        builder.addText("{pref_header_context}")
                .summary(contextExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_context_expanded", false);
                    preferences.edit().putBoolean("section_context_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (contextExpanded) {
            builder.addText("{pref_context_description}")
                    .summary("{pref_context_description_summary}");

            // Context Presets - individual buttons
            builder.addText("{preset_mobile_app}")
                    .summary("Tap to apply Mobile App context preset")
                    .onClick((pluginUI, item) -> {
                        applyContextPreset("mobile");
                        context.showToast("âœ… Mobile App preset applied!");
                    });

            builder.addText("{preset_game}")
                    .summary("Tap to apply Game context preset")
                    .onClick((pluginUI, item) -> {
                        applyContextPreset("game");
                        context.showToast("âœ… Game preset applied!");
                    });

            builder.addText("{preset_ebook}")
                    .summary("Tap to apply E-book context preset")
                    .onClick((pluginUI, item) -> {
                        applyContextPreset("ebook");
                        context.showToast("âœ… E-book preset applied!");
                    });

            builder.addText("{preset_business}")
                    .summary("Tap to apply Business App context preset")
                    .onClick((pluginUI, item) -> {
                        applyContextPreset("business");
                        context.showToast("âœ… Business App preset applied!");
                    });

            // Context spacing
            builder.addText("")
                    .summary(" ");

            builder.addInput("{pref_context_app_name}", GeminiConstants.PREF_CONTEXT_APP_NAME)
                .summary("{pref_context_app_name_summary}")
                .valueAsSummary();

        builder.addInput("{pref_context_app_type}", GeminiConstants.PREF_CONTEXT_APP_TYPE)
                .summary("{pref_context_app_type_summary}")
                .valueAsSummary();

        builder.addInput("{pref_context_audience}", GeminiConstants.PREF_CONTEXT_AUDIENCE)
                .summary("{pref_context_audience_summary}")
                .valueAsSummary();

        builder.addInput("{pref_context_tone}", GeminiConstants.PREF_CONTEXT_TONE)
                .summary("{pref_context_tone_summary}")
                .defaultValue(GeminiConstants.DEFAULT_CONTEXT_TONE)
                .valueAsSummary();

            builder.addInput("{pref_context_notes}", GeminiConstants.PREF_CONTEXT_NOTES)
                    .summary("{pref_context_notes_summary}")
                    .valueAsSummary();
        }

        // ==================== Debugging ====================
        boolean debugExpanded = preferences.getBoolean("section_debug_expanded", false);
        builder.addText("{pref_header_debug}")
                .summary(debugExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_debug_expanded", false);
                    preferences.edit().putBoolean("section_debug_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (debugExpanded) {
            builder.addSwitch("{pref_enable_debug}", GeminiConstants.PREF_ENABLE_DEBUG)
                    .defaultValue(GeminiConstants.DEFAULT_ENABLE_DEBUG)
                    .summary("{pref_enable_debug_summary}");
        }

        // ==================== Additional AI Providers ====================
        boolean moreAiExpanded = preferences.getBoolean("section_more_ai_expanded", false);
        builder.addText("{pref_header_more_ai}")
                .summary(moreAiExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_more_ai_expanded", false);
                    preferences.edit().putBoolean("section_more_ai_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (moreAiExpanded) {
            builder.addText("{pref_openai_page_title}")
                    .summary("{pref_openai_page_summary}")
                    .onClick((pluginUI, item) -> context.openPreference(OpenAITranslatePreference.class));

            builder.addText("{pref_openai_status_title}")
                    .summary(getKeyStatusDescription(
                            preferences.getString(GeminiConstants.PREF_OPENAI_API_KEY, ""),
                            GeminiConstants.OPENAI_API_KEY_PATTERN,
                            localString.get("pref_status_provider_openai")));

            // Provider separator - lighter style
            builder.addText("")
                    .summary("â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢ â€¢");

            builder.addText("{pref_claude_page_title}")
                    .summary("{pref_claude_page_summary}")
                    .onClick((pluginUI, item) -> context.openPreference(ClaudeTranslatePreference.class));

            builder.addText("{pref_claude_status_title}")
                    .summary(getKeyStatusDescription(
                            preferences.getString(GeminiConstants.PREF_CLAUDE_API_KEY, ""),
                            GeminiConstants.CLAUDE_API_KEY_PATTERN,
                            localString.get("pref_status_provider_claude")));
        }

        // ==================== Model Selection ====================
        boolean modelExpanded = preferences.getBoolean("section_model_expanded", true);
        builder.addText("{pref_header_model}")
                .summary(modelExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_model_expanded", true);
                    preferences.edit().putBoolean("section_model_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (modelExpanded) {
            builder.addList("{pref_model_name}", GeminiConstants.PREF_MODEL_NAME)
                .defaultValue(GeminiConstants.DEFAULT_MODEL)
                .summary("{pref_model_summary}")
                .addItem("{model_flash}", GeminiConstants.MODEL_GEMINI_25_FLASH)
                .addItem("{model_flash_lite}", GeminiConstants.MODEL_GEMINI_25_FLASH_LITE)
                .addItem("{model_pro}", GeminiConstants.MODEL_GEMINI_25_PRO)
                .addItem("{model_legacy}", GeminiConstants.MODEL_GEMINI_20_FLASH);

            builder.addText("{pref_rate_limits}")
                    .summary("{pref_rate_limits_summary}");
        }

        // ==================== Performance ====================
        boolean performanceExpanded = preferences.getBoolean("section_performance_expanded", false);
        builder.addText("{pref_header_performance}")
                .summary(performanceExpanded ? "â–¼ Tap to collapse" : "â–¶ Tap to expand")
                .onClick((pluginUI, item) -> {
                    boolean newState = !preferences.getBoolean("section_performance_expanded", false);
                    preferences.edit().putBoolean("section_performance_expanded", newState).apply();
                    // Preference will refresh on next open
                });

        if (performanceExpanded) {
            builder.addInput("{pref_timeout}", GeminiConstants.PREF_TIMEOUT)
                    .defaultValue(String.valueOf(GeminiConstants.DEFAULT_TIMEOUT))
                    .summary("{pref_timeout_summary}")
                    .valueAsSummary()
                    .inputType(InputType.TYPE_CLASS_NUMBER);

            builder.addInput("{pref_max_retries}", GeminiConstants.PREF_MAX_RETRIES)
                    .defaultValue(String.valueOf(GeminiConstants.DEFAULT_MAX_RETRIES))
                    .summary("{pref_max_retries_summary}")
                    .valueAsSummary()
                    .inputType(InputType.TYPE_CLASS_NUMBER);
        }

        // ==================== Information ====================
        builder.addHeader("{pref_header_info}");

        builder.addText("{pref_version}")
                .summary(GeminiConstants.PLUGIN_VERSION_NAME);

        builder.addText("{pref_free_tier}")
                .summary("{pref_free_tier_summary}");

        builder.addText("{pref_api_docs}")
                .summary("{pref_api_docs_summary}")
                .url(GeminiConstants.URL_API_DOCS);

        builder.addText("{pref_pricing}")
                .summary("{pref_pricing_summary}")
                .url(GeminiConstants.URL_PRICING);

        // ==================== Developer ====================
        builder.addHeader("{pref_header_developer}");

        builder.addText("{pref_developer_name}")
                .summary("{pref_developer_summary}");

        builder.addText("{pref_developer_github}")
                .summary("{pref_developer_github_summary}")
                .url(GeminiConstants.DEVELOPER_GITHUB);

        builder.addText("{pref_developer_linkedin}")
                .summary("{pref_developer_linkedin_summary}")
                .url(GeminiConstants.DEVELOPER_LINKEDIN);
    }

    private String getProviderHealthIndicator(String apiKey, String regex) {
        if (apiKey.isEmpty()) {
            return "âšª Not Configured";
        } else if (!Pattern.matches(regex, apiKey)) {
            return "ðŸ”´ Error (Invalid Format)";
        } else {
            // Format is valid, but we haven't tested connectivity
            return "ðŸŸ¡ Configured (Not Tested)";
        }
    }

    private void applyContextPreset(String preset) {
        SharedPreferences.Editor editor = preferences.edit();
        
        switch (preset) {
            case "mobile":
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_NAME, "Mobile Application");
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_TYPE, "Android/iOS Mobile App");
                editor.putString(GeminiConstants.PREF_CONTEXT_AUDIENCE, "General mobile users");
                editor.putString(GeminiConstants.PREF_CONTEXT_TONE, "Friendly and clear");
                editor.putString(GeminiConstants.PREF_CONTEXT_NOTES, "Use mobile-friendly terminology, keep translations concise for small screens");
                break;
            case "game":
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_NAME, "Gaming Application");
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_TYPE, "Mobile/PC Game");
                editor.putString(GeminiConstants.PREF_CONTEXT_AUDIENCE, "Gamers and casual players");
                editor.putString(GeminiConstants.PREF_CONTEXT_TONE, "Exciting and playful");
                editor.putString(GeminiConstants.PREF_CONTEXT_NOTES, "Keep game-specific terminology, maintain excitement and energy in translations");
                break;
            case "ebook":
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_NAME, "E-book Reader");
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_TYPE, "Digital Reading Platform");
                editor.putString(GeminiConstants.PREF_CONTEXT_AUDIENCE, "Book readers and literature enthusiasts");
                editor.putString(GeminiConstants.PREF_CONTEXT_TONE, "Literary and sophisticated");
                editor.putString(GeminiConstants.PREF_CONTEXT_NOTES, "Use proper literary language, maintain reading flow and elegance");
                break;
            case "business":
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_NAME, "Business Application");
                editor.putString(GeminiConstants.PREF_CONTEXT_APP_TYPE, "Professional Business Tool");
                editor.putString(GeminiConstants.PREF_CONTEXT_AUDIENCE, "Business professionals and enterprises");
                editor.putString(GeminiConstants.PREF_CONTEXT_TONE, "Professional and formal");
                editor.putString(GeminiConstants.PREF_CONTEXT_NOTES, "Use business terminology, maintain professional tone and clarity");
                break;
        }
        
        editor.apply();
    }

    private void showDashboardCard(bin.mt.plugin.api.ui.PluginUI pluginUI) {
        String geminiHealth = getProviderHealthIndicator(
            preferences.getString(GeminiConstants.PREF_API_KEY, ""),
            GeminiConstants.API_KEY_PATTERN);
        String openaiHealth = getProviderHealthIndicator(
            preferences.getString(GeminiConstants.PREF_OPENAI_API_KEY, ""),
            GeminiConstants.OPENAI_API_KEY_PATTERN);
        String claudeHealth = getProviderHealthIndicator(
            preferences.getString(GeminiConstants.PREF_CLAUDE_API_KEY, ""),
            GeminiConstants.CLAUDE_API_KEY_PATTERN);
        
        String activeProvider = getActiveProviderSummary();
        String currentEngine = preferences.getString(GeminiConstants.PREF_DEFAULT_ENGINE, GeminiConstants.DEFAULT_ENGINE);
        String activeHealth = GeminiConstants.ENGINE_OPENAI.equals(currentEngine) ? openaiHealth
                : GeminiConstants.ENGINE_CLAUDE.equals(currentEngine) ? claudeHealth
                : geminiHealth;
        
        bin.mt.plugin.api.ui.PluginView view = pluginUI
            .buildVerticalLayout()
            .addTextView().text("ðŸ“Š System Health Dashboard").bold().textSize(18).paddingBottomDp(12)
            
            // Card 1: Active Provider with Health
            .addVerticalLayout().paddingDp(12).children(subBuilder -> subBuilder
                .addTextView().text("ðŸŽ¯ Active Provider").bold().textColor(pluginUI.colorAccent())
                .addHorizontalLayout().paddingTopDp(4).children(h -> h
                    .addTextView().text(activeProvider).textSize(16)
                )
                .addTextView().text(activeHealth).paddingTopDp(2).textSize(14)
            )
            .addTextView().height(1).widthMatchParent().backgroundColor(pluginUI.colorDivider()).marginVerticalDp(8)
            
            // Card 2: All Providers Health
            .addVerticalLayout().paddingDp(12).children(subBuilder -> subBuilder
                .addTextView().text("ðŸ¥ Provider Health Status").bold().textColor(pluginUI.colorAccent())
                .addTextView().text("ðŸ’Ž Gemini: " + geminiHealth).paddingTopDp(4)
                .addTextView().text("ðŸ¤– OpenAI: " + openaiHealth).paddingTopDp(2)
                .addTextView().text("ðŸ§  Claude: " + claudeHealth).paddingTopDp(2)
            )
            .addTextView().height(1).widthMatchParent().backgroundColor(pluginUI.colorDivider()).marginVerticalDp(8)
            
            // Card 3: Model Info
            .addVerticalLayout().paddingDp(12).children(subBuilder -> subBuilder
                .addTextView().text("ðŸš€ Current Model").bold().textColor(pluginUI.colorAccent())
                .addTextView().text(preferences.getString(GeminiConstants.PREF_MODEL_NAME, GeminiConstants.DEFAULT_MODEL))
                    .paddingTopDp(4).textSize(16)
            )
            .build();
        
        pluginUI.buildDialog()
            .setTitle("ðŸ“Š Dashboard")
            .setView(view)
            .setPositiveButton("{close}", null)
            .show();
    }

    private void showInteractiveProviderTest(bin.mt.plugin.api.ui.PluginUI pluginUI) {
        String engine = preferences.getString(GeminiConstants.PREF_DEFAULT_ENGINE, GeminiConstants.DEFAULT_ENGINE);
        String providerName = getActiveProviderSummary();
        
        String key = "";
        String regex = "";
        
        if (GeminiConstants.ENGINE_OPENAI.equals(engine)) {
            key = preferences.getString(GeminiConstants.PREF_OPENAI_API_KEY, "");
            regex = GeminiConstants.OPENAI_API_KEY_PATTERN;
        } else if (GeminiConstants.ENGINE_CLAUDE.equals(engine)) {
            key = preferences.getString(GeminiConstants.PREF_CLAUDE_API_KEY, "");
            regex = GeminiConstants.CLAUDE_API_KEY_PATTERN;
        } else {
            key = preferences.getString(GeminiConstants.PREF_API_KEY, "");
            regex = GeminiConstants.API_KEY_PATTERN;
        }
        
        String statusIcon;
        String statusMsg;
        String resultMsg;
        
        if (key.isEmpty()) {
            statusIcon = "âŒ";
            statusMsg = "API Key Missing";
            resultMsg = "âš ï¸ Please configure your API key in settings.";
        } else if (!Pattern.matches(regex, key)) {
            statusIcon = "âš ï¸";
            statusMsg = "Invalid Format";
            resultMsg = "âŒ API key format is invalid. Please check your key.";
        } else {
            statusIcon = "âœ…";
            statusMsg = "Configuration Valid";
            resultMsg = "âœ¨ API key format is correct!\n\nðŸ’¡ Tip: Run 'Test API Key' in API Configuration to verify connectivity.";
        }
        
        // Build the result dialog
        bin.mt.plugin.api.ui.PluginView view = pluginUI
            .buildVerticalLayout()
            .addTextView().text("Testing: " + providerName).bold().textSize(16).paddingBottomDp(16)
            
            // Status card
            .addVerticalLayout().paddingDp(12).children(subBuilder -> subBuilder
                .addHorizontalLayout().children(h -> h
                    .addTextView().text(statusIcon).textSize(32).paddingRightDp(12)
                    .addVerticalLayout().children(v -> v
                        .addTextView().text(statusMsg).bold().textSize(16)
                        .addTextView().text(resultMsg).paddingTopDp(4).textSize(14)
                    )
                )
            )
            .build();
        
        pluginUI.buildDialog()
            .setTitle("ðŸ§ª Provider Test")
            .setView(view)
            .setPositiveButton("{close}", null)
            .show();
    }

    private boolean isValidApiKey(String apiKey) {
        return Pattern.matches(GeminiConstants.API_KEY_PATTERN, apiKey);
    }

    private String getActiveProviderSummary() {
        String engine = preferences.getString(GeminiConstants.PREF_DEFAULT_ENGINE, GeminiConstants.DEFAULT_ENGINE);
        switch (engine == null ? GeminiConstants.DEFAULT_ENGINE : engine) {
            case GeminiConstants.ENGINE_OPENAI:
                return localString.get("pref_ai_engine_openai");
            case GeminiConstants.ENGINE_CLAUDE:
                return localString.get("pref_ai_engine_claude");
            case GeminiConstants.ENGINE_GEMINI:
            default:
                return localString.get("pref_ai_engine_gemini");
        }
    }

    private String getKeyStatusDescription(String key, String regex, String providerLabel) {
        if (key == null || key.trim().isEmpty()) {
            return providerLabel + ": " + localString.get("pref_status_missing");
        }
        if (regex != null && !Pattern.matches(regex, key)) {
            return providerLabel + ": " + localString.get("pref_status_invalid_format");
        }
        return providerLabel + ": " + localString.get("pref_status_ready");
    }

    private void testSelectedProvider() {
        String engine = preferences.getString(GeminiConstants.PREF_DEFAULT_ENGINE, GeminiConstants.DEFAULT_ENGINE);
        String toast;
        if (GeminiConstants.ENGINE_OPENAI.equals(engine)) {
            toast = getKeyStatusDescription(
                    preferences.getString(GeminiConstants.PREF_OPENAI_API_KEY, ""),
                    GeminiConstants.OPENAI_API_KEY_PATTERN,
                    localString.get("pref_status_provider_openai"));
        } else if (GeminiConstants.ENGINE_CLAUDE.equals(engine)) {
            toast = getKeyStatusDescription(
                    preferences.getString(GeminiConstants.PREF_CLAUDE_API_KEY, ""),
                    GeminiConstants.CLAUDE_API_KEY_PATTERN,
                    localString.get("pref_status_provider_claude"));
        } else {
            toast = getKeyStatusDescription(
                    preferences.getString(GeminiConstants.PREF_API_KEY, ""),
                    GeminiConstants.API_KEY_PATTERN,
                    localString.get("pref_status_provider_gemini"));
        }
        context.showToast(toast);
    }

    private void testApiKey() {
        SharedPreferences prefs = context.getPreferences();
        String apiKey = prefs.getString(GeminiConstants.PREF_API_KEY, "");
        String model = prefs.getString(GeminiConstants.PREF_MODEL_NAME, GeminiConstants.DEFAULT_MODEL);

        if (apiKey.isEmpty()) {
            context.showToast(localString.get("error_no_api_key"));
            return;
        }

        new Thread(() -> {
            try {
                // Build test request
                org.json.JSONObject request = new org.json.JSONObject();
                org.json.JSONArray contents = new org.json.JSONArray();
                org.json.JSONObject content = new org.json.JSONObject();
                org.json.JSONArray parts = new org.json.JSONArray();
                org.json.JSONObject part = new org.json.JSONObject();
                part.put("text", "Translate to Turkish: Hello");
                parts.put(part);
                content.put("parts", parts);
                contents.put(content);
                request.put("contents", contents);

                // Test API
                String apiUrl = String.format("%s/%s:generateContent?key=%s",
                    GeminiConstants.API_BASE_URL, model, apiKey);

                GeminiHttpUtils.Request httpRequest = GeminiHttpUtils.post(apiUrl);
                httpRequest.setTimeout(10000);
                httpRequest.jsonBody(request);

                org.json.JSONObject response = httpRequest.executeToJson();

                if (response.has("candidates")) {
                    context.showToast(localString.get("msg_api_key_valid"));
                } else {
                    context.showToast(localString.get("error_api_key_invalid"));
                }

            } catch (Exception e) {
                String errorMsg = localString.get("error_api_test_failed") + ": " + e.getMessage();
                context.showToast(errorMsg);
            }
        }).start();
    }
}
